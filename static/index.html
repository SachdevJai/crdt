<!DOCTYPE html>
<html>
<body>
  <!-- Textarea for user input -->
  <textarea id="input" placeholder="Type message" autocomplete="off" rows="10" cols="50"></textarea>
  
  <!-- List for logging messages -->
  <ul id="log"></ul>

  <script>
    const ws = new WebSocket("ws://localhost:8080/ws");
    let lastValue = ""; // Tracks the previous input value

    // When WebSocket is open, log the connection
    ws.onopen = () => {
      const li = document.createElement("li");
      li.textContent = "Connected to the server!";
      document.getElementById("log").appendChild(li);
    };

    // When WebSocket receives a message from the server, handle it
    ws.onmessage = (e) => {
      const data = e.data;
      
      try {
        const message = JSON.parse(data);
        if (Array.isArray(message)) {
          // This is the initial document sent from the server
          const documentText = message.join(""); // Join the array of strings into a single document text
          document.getElementById("input").value = documentText;
          lastValue = documentText; // Initialize lastValue with the document text
        } else {
          // If the message is not an initial document, treat it as a log message
          const li = document.createElement("li");
          li.textContent = "Server: " + data;
          document.getElementById("log").appendChild(li);
        }
      } catch (err) {
        console.error("Error handling message:", err);
      }
    };

    // When WebSocket is closed, log the disconnection
    ws.onclose = () => {
      const li = document.createElement("li");
      li.textContent = "Disconnected from the server!";
      document.getElementById("log").appendChild(li);
    };

    // Send operation (insert or delete) to the server
    const sendOp = (type, position, value) => {
      const msg = {
        type,
        position,
        value,
        timestamp: new Date().toISOString()
      };
      ws.send(JSON.stringify(msg));
    };

    // Handle changes to the textarea
    const inputEl = document.getElementById("input");

    inputEl.addEventListener("input", (e) => {
      const currentValue = e.target.value;

      const minLen = Math.min(lastValue.length, currentValue.length);
      let changeIndex = 0;
      while (
        changeIndex < minLen &&
        lastValue[changeIndex] === currentValue[changeIndex]
      ) {
        changeIndex++;
      }

      // Inserted characters
      if (currentValue.length > lastValue.length) {
        const inserted = currentValue.slice(changeIndex, currentValue.length);
        sendOp("insert", changeIndex, inserted);
      }

      // Deleted characters
      if (currentValue.length < lastValue.length) {
        const deleted = lastValue.slice(changeIndex, lastValue.length);
        sendOp("delete", changeIndex, deleted);
      }

      lastValue = currentValue;
    });
  </script>
</body>
</html>
